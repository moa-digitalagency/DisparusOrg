<!--
 * Nom de l'application : DISPARUS.ORG
 * Description : Formulaire de signalement de disparition
 * Produit de : MOA Digital Agency, www.myoneart.com
 * Fait par : Aisance KALONJI, www.aisancekalonji.com
 * Auditer par : La CyberConfiance, www.cyberconfiance.com
 -->
{% extends "base.html" %}

{% block title %}{{ t('report_form.title') }} - {{ t('site.name') }}{% endblock %}

{% block content %}
{% if blocked_attempt %}
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden border-2 border-red-600">
        <div class="bg-red-600 text-white p-6 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-white/90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            <h3 class="text-2xl font-bold uppercase tracking-wide">{% if get_locale() == 'fr' %}Alerte de Sécurité{% else %}Security Alert{% endif %}</h3>
        </div>
        <div class="p-8 text-center space-y-4">
            <p class="text-lg text-gray-800 font-semibold leading-relaxed">
                {% if get_locale() == 'fr' %}
                Vous essayez de télécharger un contenu de type <span class="text-red-600 font-bold uppercase">{{ blocked_attempt.detection_type }}</span>.
                {% else %}
                You are attempting to upload content of type <span class="text-red-600 font-bold uppercase">{{ blocked_attempt.detection_type }}</span>.
                {% endif %}
            </p>

            <div class="bg-gray-100 p-4 rounded-lg text-sm text-left border border-gray-200">
                <p class="font-mono text-gray-600 mb-1"><strong>IP:</strong> {{ blocked_attempt.ip_address }}</p>
                <p class="font-mono text-gray-600"><strong>Location:</strong> {{ blocked_attempt.city }}, {{ blocked_attempt.country }}</p>
            </div>

            <div class="p-4 bg-red-50 border border-red-100 rounded-lg text-sm text-red-800">
                {% if get_locale() == 'fr' %}
                Votre action a été enregistrée avec vos informations d'identification. Une enquête est en cours. En cas de confirmation, des poursuites auprès des autorités compétentes peuvent être entreprises.
                {% else %}
                Your action has been recorded with your identification details. An investigation is underway. In case of confirmation, legal proceedings with the competent authorities may be undertaken.
                {% endif %}
            </div>

            <button onclick="window.location.href='/'" class="w-full bg-gray-900 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-xl transition-all mt-4">
                {% if get_locale() == 'fr' %}J'ai compris{% else %}I understand{% endif %}
            </button>
        </div>
    </div>
</div>
{% endif %}

<section class="bg-gradient-to-br from-red-700 to-red-900 text-white py-12 relative overflow-hidden">
    <div class="absolute inset-0 bg-black/20"></div>
    <div class="max-w-7xl mx-auto px-4 relative z-10">
        <div class="text-center max-w-3xl mx-auto">
            <div class="inline-flex items-center gap-2 bg-white/10 px-4 py-1.5 rounded-xl text-sm font-medium mb-4">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                {{ t('report_form.badge') }}
            </div>
            <h1 class="text-xl md:text-2xl font-bold mb-3 tracking-tight leading-tight" data-testid="text-report-title">
                {{ t('report_form.title') }}
            </h1>
            <div class="w-16 h-1 bg-white/50 rounded-full mx-auto mb-4"></div>
            <p class="text-base text-red-100 opacity-90">
                {{ t('report_form.subtitle') }}
            </p>
        </div>
    </div>
</section>

<section class="py-12 bg-gray-50/50">
    <div class="max-w-3xl mx-auto px-4">
        {% if error %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-6" data-testid="error-message">
            {{ error }}
        </div>
        {% endif %}
        
        <form action="/signaler" method="POST" enctype="multipart/form-data" class="space-y-5">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <!-- Tabs -->
            <div class="flex gap-2 p-1 bg-gray-100 rounded-xl mb-6">
                <button type="button" onclick="switchTab('person')" id="tab-person" class="flex-1 py-2.5 px-4 rounded-lg text-sm font-semibold bg-white text-red-700 shadow-sm transition-all">
                    {% if get_locale() == 'fr' %}Personne{% else %}Person{% endif %}
                </button>
                <button type="button" onclick="switchTab('animal')" id="tab-animal" class="flex-1 py-2.5 px-4 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all">
                    {% if get_locale() == 'fr' %}Animal{% else %}Animal{% endif %}
                </button>
            </div>

            <div class="bg-white rounded-xl border border-red-100 p-5 shadow-sm">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 bg-red-100 rounded-xl flex items-center justify-center text-red-700 font-semibold text-sm">1</div>
                    <h2 class="text-base font-semibold text-gray-900">
                        {{ t('report_form.section_identity') }}
                    </h2>
                </div>
                <div class="h-0.5 w-full bg-gradient-to-r from-red-500 via-red-300 to-transparent rounded-full mb-4"></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" name="person_type" id="person_type_input" value="adult">

                    <!-- Person Fields -->
                    <div id="block-person-type">
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.person_type') }} *</label>
                        <select id="person_type_select" onchange="document.getElementById('person_type_input').value = this.value" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="select-person-type">
                            <option value="child">{{ t('report_form.child') }}</option>
                            <option value="adult" selected>{{ t('report_form.adult') }}</option>
                            <option value="elderly">{{ t('report_form.elderly') }}</option>
                        </select>
                    </div>

                    <!-- Animal Fields -->
                    <div id="block-animal-type" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-1">{% if get_locale() == 'fr' %}Type d'animal{% else %}Animal Type{% endif %} *</label>
                        <select name="animal_type" id="animal_type_select" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm">
                            <option value="dog">{% if get_locale() == 'fr' %}Chien{% else %}Dog{% endif %}</option>
                            <option value="cat">{% if get_locale() == 'fr' %}Chat{% else %}Cat{% endif %}</option>
                            <option value="other">{% if get_locale() == 'fr' %}Autre{% else %}Other{% endif %}</option>
                        </select>
                    </div>

                    <div id="block-breed" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-1">{% if get_locale() == 'fr' %}Race / Espèce{% else %}Breed / Species{% endif %}</label>
                        <input type="text" name="breed" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.sex') }} *</label>
                        <select name="sex" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="select-sex">
                            <option value="male" id="sex_option_male">{{ t('report_form.male') }}</option>
                            <option value="female" id="sex_option_female">{{ t('report_form.female') }}</option>
                            <option value="unknown">{{ t('report_form.unknown_sex') }}</option>
                        </select>
                    </div>
                    <div>
                        <label id="label-first-name" class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.first_name') }} *</label>
                        <input type="text" name="first_name" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="input-first-name">
                    </div>
                    <div id="block-last-name">
                        <label id="label-last-name" class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.last_name') }} *</label>
                        <input type="text" name="last_name" id="input-last-name" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="input-last-name">
                    </div>
                    <div id="block-age">
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.age') }}</label>
                        <input type="number" name="age" min="0" max="120" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="input-age">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.photo') }}</label>
                        <input type="file" name="photo" accept="image/*" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="input-photo">
                        <p class="text-xs text-gray-500 mt-1">{{ t('report_form.photo_hint') }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl border border-red-100 p-5 shadow-sm">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 bg-red-100 rounded-xl flex items-center justify-center text-red-700 font-semibold text-sm">2</div>
                    <h2 class="text-base font-semibold text-gray-900">
                        {{ t('report_form.section_location') }}
                    </h2>
                </div>
                <div class="h-0.5 w-full bg-gradient-to-r from-red-500 via-red-300 to-transparent rounded-full mb-4"></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.country') }} *</label>
                        <select name="country" id="country-select" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="select-country">
                            <option value="">{{ t('report_form.select_country') }}</option>
                            {% for c in countries %}
                            <option value="{{ c }}">{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.city') }} *</label>
                        <select name="city" id="city-select" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="select-city">
                            <option value="">{{ t('report_form.select_country_first') }}</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.geolocation') }} *</label>

                    <div class="flex gap-2 mb-2">
                        <input type="text" id="address-search" placeholder="{% if get_locale() == 'fr' %}Rechercher une adresse...{% else %}Search an address...{% endif %}" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm">
                        <button type="button" onclick="searchAddress()" id="btn-search-address" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </button>
                    </div>

                    <div id="location-map" class="h-56 rounded-xl border border-gray-200 mb-2"></div>
                    <div class="flex flex-col gap-2">
                        <span class="text-sm text-gray-500" id="coords-display">{{ t('report_form.click_map') }}</span>
                        <div>
                            <button type="button" onclick="getGeoLocation()" class="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all" data-testid="button-geolocate">
                                {{ t('report_form.my_gps') }}
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="latitude" id="latitude">
                    <input type="hidden" name="longitude" id="longitude">
                </div>
            </div>
            
            <div class="bg-white rounded-xl border border-red-100 p-5 shadow-sm">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 bg-red-100 rounded-xl flex items-center justify-center text-red-700 font-semibold text-sm">3</div>
                    <h2 class="text-base font-semibold text-gray-900">
                        {{ t('report_form.section_description') }}
                    </h2>
                </div>
                <div class="h-0.5 w-full bg-gradient-to-r from-red-500 via-red-300 to-transparent rounded-full mb-4"></div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.physical_desc') }} *</label>
                        <textarea name="physical_description" rows="3" required placeholder="{{ t('report_form.physical_desc_placeholder') }}" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="textarea-description"></textarea>
                    </div>
                    <div>
                        <label id="label-clothing" class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.clothing') }} *</label>
                        <input type="text" name="clothing" required placeholder="{{ t('report_form.clothing_placeholder') }}" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="input-clothing">
                    </div>
                    <div id="block-objects">
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.objects') }}</label>
                        <input type="text" name="objects" placeholder="{{ t('report_form.objects_placeholder') }}" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="input-objects">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.disappearance_date') }} *</label>
                        <input type="datetime-local" name="disappearance_date" required class="w-full max-w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm box-border" data-testid="input-date">
                    </div>
                    <div id="block-circumstances">
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.circumstances') }}</label>
                        <textarea name="circumstances" rows="3" placeholder="{{ t('report_form.circumstances_placeholder') }}" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="textarea-circumstances"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl border border-red-100 p-5 shadow-sm">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 bg-red-100 rounded-xl flex items-center justify-center text-red-700 font-semibold text-sm">4</div>
                    <h2 class="text-base font-semibold text-gray-900">
                        {{ t('report_form.reference_contacts') }}
                    </h2>
                </div>
                <div class="h-0.5 w-full bg-gradient-to-r from-red-500 via-red-300 to-transparent rounded-full mb-4"></div>
                
                <div id="contacts-container" class="space-y-4">
                    <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.full_name') }} *</label>
                                <input type="text" name="contact_name_0" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="input-contact-name-0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.contact_phone') }} *</label>
                                <input type="tel" name="contact_phone_0" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="input-contact-phone-0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.contact_email') }}</label>
                                <input type="email" name="contact_email_0" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="input-contact-email-0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('report_form.relationship') }}</label>
                                <input type="text" name="contact_relation_0" placeholder="{{ t('report_form.relationship_placeholder') }}" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm" data-testid="input-contact-relation-0">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-start gap-3 bg-white rounded-xl border border-red-100 p-5 shadow-sm">
                <input type="checkbox" name="consent" required id="consent" class="mt-0.5 w-4 h-4 rounded border-gray-300 text-red-600 focus:ring-red-500" data-testid="checkbox-consent">
                <label for="consent" class="text-sm text-gray-600">
                    {{ t('report_form.consent') }} *
                </label>
            </div>

            <div class="bg-red-50 border border-red-100 rounded-xl p-4 text-xs text-red-800 leading-relaxed">
                <p class="font-bold mb-1">{% if get_locale() == 'fr' %}AVERTISSEMENT LEGAL{% else %}LEGAL WARNING{% endif %}</p>
                <p>
                    {% if get_locale() == 'fr' %}
                    La publication de fausses informations, la diffamation ou le partage de contenus illicites (pornographie, violence) entraînera un bannissement immédiat. Une plainte pourra être déposée auprès des autorités compétentes. Toutes les actions sur cette plateforme sont monitorées, historisées et auditables.
                    {% else %}
                    Publishing false information, defamation, or sharing illicit content (pornography, violence) will result in an immediate ban. A complaint may be filed with the competent authorities. All actions on this platform are monitored, logged, and auditable.
                    {% endif %}
                </p>
            </div>
            
            <button type="submit" class="w-full bg-red-700 hover:bg-red-800 text-white font-semibold py-3 px-6 rounded-xl shadow-sm hover:shadow-md transition-all flex items-center justify-center gap-2 text-sm" data-testid="button-submit">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                {{ t('report_form.publish') }}
            </button>
        </form>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Auto-detect location via IP on load
    document.addEventListener('DOMContentLoaded', function() {
        if (!document.getElementById('country-select').value) {
            fetch('/api/geo/ip')
                .then(res => res.json())
                .then(data => {
                    if (data.country) {
                        const countrySelect = document.getElementById('country-select');
                        for (let i = 0; i < countrySelect.options.length; i++) {
                            if (countrySelect.options[i].value.toLowerCase() === data.country.toLowerCase()) {
                                countrySelect.selectedIndex = i;
                                countrySelect.dispatchEvent(new Event('change'));

                                setTimeout(() => {
                                    if (data.city) {
                                        const citySelect = document.getElementById('city-select');
                                        for (let j = 0; j < citySelect.options.length; j++) {
                                            if (citySelect.options[j].value.toLowerCase() === data.city.toLowerCase()) {
                                                citySelect.selectedIndex = j;
                                                break;
                                            }
                                        }
                                    }
                                }, 300);
                                break;
                            }
                        }
                    }
                })
                .catch(err => console.log('IP Geo failed', err));
        }
    });

    const countriesCities = {{ countries_cities|tojson|safe }};
    
    const countrySelect = document.getElementById('country-select');
    const citySelect = document.getElementById('city-select');
    
    countrySelect.addEventListener('change', function() {
        const country = this.value;
        citySelect.innerHTML = '<option value="">{{ t("report_form.select_city") }}</option>';
        
        if (country && countriesCities[country]) {
            countriesCities[country].forEach(function(city) {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }
    });
    
    const locationMap = L.map('location-map').setView([7.5, 15], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'OpenStreetMap'
    }).addTo(locationMap);
    
    let marker = null;
    
    locationMap.on('click', function(e) {
        setLocation(e.latlng.lat, e.latlng.lng);
    });
    
    function setLocation(lat, lng) {
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
        document.getElementById('coords-display').textContent = lat.toFixed(4) + ', ' + lng.toFixed(4);
        
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(locationMap);
        }
        locationMap.setView([lat, lng], 16);
    }

    function searchAddress() {
        const input = document.getElementById('address-search');
        const btn = document.getElementById('btn-search-address');
        const query = input.value;
        const country = document.getElementById('country-select').value;
        const city = document.getElementById('city-select').value;

        if (!query) return;

        const originalBtnContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

        let fullQuery = query;
        // Append context to query string to ensure search is focused on selected area
        if (city) {
            fullQuery += `, ${city}`;
        }
        if (country) {
            fullQuery += `, ${country}`;
        }

        let searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullQuery)}`;

        fetch(searchUrl)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    setLocation(lat, lon);
                } else {
                    alert("{% if get_locale() == 'fr' %}Adresse introuvable{% else %}Address not found{% endif %}");
                }
            })
            .catch(err => {
                console.error(err);
                alert("{% if get_locale() == 'fr' %}Erreur lors de la recherche{% else %}Search error{% endif %}");
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
            });
    }

    // Trigger search on Enter key
    document.getElementById('address-search').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchAddress();
        }
    });
    
    function getGeoLocation() {
        const btn = document.querySelector('button[onclick="getGeoLocation()"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Localisation...';

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                setLocation(lat, lng);

                // Reverse geocoding to find Country and City
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.address) {
                            const country = data.address.country;
                            const city = data.address.city || data.address.town || data.address.village || data.address.municipality;

                            if (country) {
                                // Select Country
                                const countrySelect = document.getElementById('country-select');
                                for (let i = 0; i < countrySelect.options.length; i++) {
                                    if (countrySelect.options[i].text.toLowerCase() === country.toLowerCase() ||
                                        countrySelect.options[i].value.toLowerCase() === country.toLowerCase()) {
                                        countrySelect.selectedIndex = i;
                                        // Trigger change to populate cities
                                        countrySelect.dispatchEvent(new Event('change'));

                                        // Wait a bit for cities to populate then select city
                                        setTimeout(() => {
                                            if (city) {
                                                const citySelect = document.getElementById('city-select');
                                                for (let j = 0; j < citySelect.options.length; j++) {
                                                    if (citySelect.options[j].text.toLowerCase() === city.toLowerCase() ||
                                                        citySelect.options[j].value.toLowerCase() === city.toLowerCase()) {
                                                        citySelect.selectedIndex = j;
                                                        break;
                                                    }
                                                }
                                            }
                                        }, 100);
                                        break;
                                    }
                                }
                            }
                        }
                    })
                    .catch(err => console.error("Geocoding error:", err))
                    .finally(() => {
                         btn.disabled = false;
                         btn.innerHTML = originalText;
                    });

            }, function(err) {
                alert('{{ t("report_form.geo_error") }}');
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        } else {
            alert("Geolocation is not supported by this browser.");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.querySelector('input[name="disappearance_date"]').value = now.toISOString().slice(0, 16);

    // Tab System
    function switchTab(type) {
        // Style updates
        const activeClass = "flex-1 py-2.5 px-4 rounded-lg text-sm font-semibold bg-white text-red-700 shadow-sm transition-all";
        const inactiveClass = "flex-1 py-2.5 px-4 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all";

        const tabPerson = document.getElementById('tab-person');
        const tabAnimal = document.getElementById('tab-animal');

        if (tabPerson) tabPerson.className = type === 'person' ? activeClass : inactiveClass;
        if (tabAnimal) tabAnimal.className = type === 'animal' ? activeClass : inactiveClass;

        const blockPersonType = document.getElementById('block-person-type');
        const blockAnimalType = document.getElementById('block-animal-type');
        const blockBreed = document.getElementById('block-breed');
        const blockLastName = document.getElementById('block-last-name');
        const blockAge = document.getElementById('block-age');
        const blockObjects = document.getElementById('block-objects');
        const blockCircumstances = document.getElementById('block-circumstances');

        const sexMale = document.getElementById('sex_option_male');
        const sexFemale = document.getElementById('sex_option_female');

        // Logic
        if (type === 'animal') {
            blockPersonType.style.display = 'none';
            blockAnimalType.style.display = 'block';
            blockBreed.style.display = 'block';
            blockLastName.style.display = 'none';
            blockAge.style.display = 'none';
            blockObjects.style.display = 'none';
            blockCircumstances.style.display = 'none';

            // Disable requirement for Last Name
            document.getElementById('input-last-name').required = false;

            document.getElementById('person_type_input').value = 'animal';

            // Update labels for Animal
            document.getElementById('label-first-name').textContent = "{% if get_locale() == 'fr' %}Nom de l'animal{% else %}Animal Name{% endif %} *";
            document.getElementById('label-clothing').textContent = "{% if get_locale() == 'fr' %}Collier / Accessoires / Signes distinctifs{% else %}Collar / Accessories / Distinctive marks{% endif %} *";

            // Sex Options
            sexMale.textContent = "{% if get_locale() == 'fr' %}Mâle{% else %}Male{% endif %}";
            sexFemale.textContent = "{% if get_locale() == 'fr' %}Femelle{% else %}Female{% endif %}";

        } else {
             blockPersonType.style.display = 'block';
             blockAnimalType.style.display = 'none';
             blockBreed.style.display = 'none';
             blockLastName.style.display = 'block';
             blockAge.style.display = 'block';
             blockObjects.style.display = 'block';
             blockCircumstances.style.display = 'block';

             // Enable requirement for Last Name
             document.getElementById('input-last-name').required = true;

             // Reset input value from select
             document.getElementById('person_type_input').value = document.getElementById('person_type_select').value;

             // Reset labels for Person
             document.getElementById('label-first-name').textContent = "{{ t('report_form.first_name') }} *";
             document.getElementById('label-clothing').textContent = "{{ t('report_form.clothing') }} *";

             // Sex Options
             sexMale.textContent = "{{ t('report_form.male') }}";
             sexFemale.textContent = "{{ t('report_form.female') }}";
        }
    }
</script>
{% endblock %}
