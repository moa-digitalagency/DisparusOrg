<!--
 * Nom de l'application : DISPARUS.ORG
 * Description : Carte interactive de l'administration
 * Produit de : MOA Digital Agency, www.myoneart.com
 * Fait par : Aisance KALONJI, www.aisancekalonji.com
 * Auditer par : La CyberConfiance, www.cyberconfiance.com
 -->
{% extends "admin_base.html" %}

{% block title %}Carte - Admin DISPARUS.ORG{% endblock %}

{% block page_title %}{% if get_locale() == 'fr' %}Carte interactive{% else %}Interactive map{% endif %}{% endblock %}
{% block page_subtitle %}{% if get_locale() == 'fr' %}Visualisation geographique des signalements{% else %}Geographic visualization of reports{% endif %}{% endblock %}

{% block admin_content %}
<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
    <div class="p-4 border-b border-gray-100 flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="text-sm text-gray-600">{% if get_locale() == 'fr' %}Disparu{% else %}Missing{% endif %}</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="text-sm text-gray-600">{% if get_locale() == 'fr' %}Retrouve{% else %}Found{% endif %}</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                <span class="text-sm text-gray-600">{% if get_locale() == 'fr' %}Signale{% else %}Flagged{% endif %}</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <select id="admin-country-filter" class="text-sm border border-gray-200 rounded-xl px-3 py-2 bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500">
                <option value="">{% if get_locale() == 'fr' %}Tous les pays{% else %}All countries{% endif %}</option>
                {% set countries = disparus|map(attribute='country')|unique|sort %}
                {% for country in countries %}
                <option value="{{ country }}">{{ country }}</option>
                {% endfor %}
            </select>
            <span id="admin-count" class="text-sm text-gray-500">
                {{ disparus|length }} {% if get_locale() == 'fr' %}signalements{% else %}reports{% endif %}
            </span>
        </div>
    </div>
    <div id="admin-map" class="h-[600px]"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Escape HTML utility function to prevent XSS
    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    const map = L.map('admin-map').setView([7.5, 15], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'OpenStreetMap'
    }).addTo(map);
    
    const allDisparus = {{ disparus_list|tojson|safe if disparus_list else '[]' }};
    const adminCountryFilter = document.getElementById('admin-country-filter');
    const adminCount = document.getElementById('admin-count');
    let mapMarkers = [];
    
    const savedAdminCountry = localStorage.getItem('disparus_admin_country_filter');
    if (savedAdminCountry) {
        adminCountryFilter.value = savedAdminCountry;
    }
    
    function updateAdminMap() {
        mapMarkers.forEach(m => map.removeLayer(m));
        mapMarkers = [];
        
        const selectedCountry = adminCountryFilter.value;
        let filtered = allDisparus;
        
        if (selectedCountry) {
            filtered = allDisparus.filter(d => d.country === selectedCountry);
        }
        
        adminCount.textContent = filtered.length + ' {% if get_locale() == "fr" %}signalements{% else %}reports{% endif %}';
        
        filtered.forEach(function(d) {
            if (d.latitude && d.longitude) {
                const color = d.status === 'found' ? '#22c55e' : (d.is_flagged ? '#f97316' : '#ef4444');
                const marker = L.circleMarker([d.latitude, d.longitude], {
                    radius: 10,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);
            
            // Tooltip on Hover
            const tooltipContent = `
                <div class="flex items-center gap-3 p-1 min-w-[200px]">
                    ${d.photo_url
                        ? `<img src="${d.photo_url}" class="w-12 h-12 rounded-lg object-cover border border-gray-200">`
                        : `<div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center border border-gray-200"><span class="text-xs text-gray-400">No img</span></div>`
                    }
                    <div>
                        <div class="font-bold text-sm text-gray-900">${escapeHtml(d.first_name)} ${escapeHtml(d.last_name)}</div>
                        <div class="text-xs text-gray-500">${escapeHtml(d.city)}, ${escapeHtml(d.country)}</div>
                    </div>
                </div>
            `;

            marker.bindTooltip(tooltipContent, {
                permanent: false,
                direction: 'top',
                className: 'bg-white border-0 shadow-lg rounded-xl overflow-hidden p-0',
                offset: [0, -10],
                opacity: 1
            });
            
            // Redirect on Click
            marker.on('click', function() {
                window.location.href = '/disparu/' + d.public_id;
            });
            
            mapMarkers.push(marker);
        }
        });
        
        if (mapMarkers.length > 0) {
            const bounds = mapMarkers.map(m => m.getLatLng());
            map.fitBounds(bounds.map(b => [b.lat, b.lng]), {padding: [30, 30], maxZoom: 10});
        }
    }
    
    adminCountryFilter.addEventListener('change', function() {
        localStorage.setItem('disparus_admin_country_filter', this.value);
        updateAdminMap();
    });
    
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                if (!adminCountryFilter.value) {
                    map.setView([position.coords.latitude, position.coords.longitude], 8);
                }
            },
            function() {},
            { enableHighAccuracy: false, timeout: 5000 }
        );
    }
    
    updateAdminMap();
</script>
{% endblock %}
