{% extends "admin_base.html" %}

{% block title %}Carte - Admin DISPARUS.ORG{% endblock %}

{% block page_title %}{% if get_locale() == 'fr' %}Carte interactive{% else %}Interactive map{% endif %}{% endblock %}
{% block page_subtitle %}{% if get_locale() == 'fr' %}Visualisation geographique des signalements{% else %}Geographic visualization of reports{% endif %}{% endblock %}

{% block admin_content %}
<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
    <div class="p-4 border-b border-gray-100 flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="text-sm text-gray-600">{% if get_locale() == 'fr' %}Disparu{% else %}Missing{% endif %}</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="text-sm text-gray-600">{% if get_locale() == 'fr' %}Retrouve{% else %}Found{% endif %}</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                <span class="text-sm text-gray-600">{% if get_locale() == 'fr' %}Signale{% else %}Flagged{% endif %}</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <select id="admin-country-filter" class="text-sm border border-gray-200 rounded-xl px-3 py-2 bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500">
                <option value="">{% if get_locale() == 'fr' %}Tous les pays{% else %}All countries{% endif %}</option>
                {% set countries = disparus|map(attribute='country')|unique|sort %}
                {% for country in countries %}
                <option value="{{ country }}">{{ country }}</option>
                {% endfor %}
            </select>
            <span id="admin-count" class="text-sm text-gray-500">
                {{ disparus|length }} {% if get_locale() == 'fr' %}signalements{% else %}reports{% endif %}
            </span>
        </div>
    </div>
    <div id="admin-map" class="h-[600px]"></div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .hover-card {
        position: absolute;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        padding: 12px;
        z-index: 1000;
        pointer-events: none;
        min-width: 220px;
        max-width: 280px;
        border: 1px solid #e5e7eb;
        transform: translate(-50%, -100%);
        margin-top: -15px;
    }
    .hover-card img {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid #fee2e2;
    }
    .hover-card .no-photo {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
<div id="hover-card" class="hover-card hidden">
    <div class="flex gap-3">
        <div id="hover-photo"></div>
        <div class="flex-1">
            <div id="hover-name" class="font-semibold text-gray-900 text-sm"></div>
            <div id="hover-location" class="text-xs text-gray-500 mt-0.5"></div>
            <div id="hover-status" class="mt-1"></div>
            <div id="hover-date" class="text-xs text-gray-400 mt-1"></div>
        </div>
    </div>
    <a id="hover-link" href="#" class="block mt-2 text-center text-xs text-red-600 hover:text-red-700 font-medium py-1.5 bg-red-50 rounded-lg">
        {% if get_locale() == 'fr' %}Voir la fiche{% else %}View profile{% endif %}
    </a>
</div>
<script>
    const map = L.map('admin-map').setView([7.5, 15], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'OpenStreetMap'
    }).addTo(map);
    
    const hoverCard = document.getElementById('hover-card');
    const allDisparus = {{ disparus|tojson|safe if disparus else '[]' }};
    const adminCountryFilter = document.getElementById('admin-country-filter');
    const adminCount = document.getElementById('admin-count');
    let mapMarkers = [];
    
    const savedAdminCountry = localStorage.getItem('disparus_admin_country_filter');
    if (savedAdminCountry) {
        adminCountryFilter.value = savedAdminCountry;
    }
    
    function updateAdminMap() {
        mapMarkers.forEach(m => map.removeLayer(m));
        mapMarkers = [];
        
        const selectedCountry = adminCountryFilter.value;
        let filtered = allDisparus;
        
        if (selectedCountry) {
            filtered = allDisparus.filter(d => d.country === selectedCountry);
        }
        
        adminCount.textContent = filtered.length + ' {% if get_locale() == "fr" %}signalements{% else %}reports{% endif %}';
        
        filtered.forEach(function(d) {
            if (d.latitude && d.longitude) {
                const color = d.status === 'found' ? '#22c55e' : (d.is_flagged ? '#f97316' : '#ef4444');
                const marker = L.circleMarker([d.latitude, d.longitude], {
                    radius: 10,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);
            
            marker.on('mouseover', function(e) {
                const photoHtml = d.photo_url 
                    ? '<img src="' + d.photo_url + '" alt="Photo">'
                    : '<div class="no-photo"><svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>';
                
                document.getElementById('hover-photo').innerHTML = photoHtml;
                document.getElementById('hover-name').textContent = d.first_name + ' ' + d.last_name;
                document.getElementById('hover-location').textContent = d.city + ', ' + d.country;
                
                const statusLabel = d.status === 'found' ? '{% if get_locale() == "fr" %}Retrouve{% else %}Found{% endif %}' : 
                                   d.status === 'deceased' ? '{% if get_locale() == "fr" %}Decede{% else %}Deceased{% endif %}' : 
                                   '{% if get_locale() == "fr" %}Disparu{% else %}Missing{% endif %}';
                const statusClass = d.status === 'found' ? 'bg-green-100 text-green-700' : 
                                   d.status === 'deceased' ? 'bg-gray-100 text-gray-700' : 'bg-red-100 text-red-700';
                document.getElementById('hover-status').innerHTML = '<span class="inline-block px-2 py-0.5 rounded text-xs font-medium ' + statusClass + '">' + statusLabel + '</span>';
                
                const date = d.disappearance_date ? new Date(d.disappearance_date).toLocaleDateString('fr-FR') : '';
                document.getElementById('hover-date').textContent = date ? '{% if get_locale() == "fr" %}Disparu le{% else %}Missing since{% endif %} ' + date : '';
                
                document.getElementById('hover-link').href = '/disparu/' + d.public_id;
                document.getElementById('hover-link').style.pointerEvents = 'auto';
                
                const point = map.latLngToContainerPixel(e.latlng);
                const mapContainer = document.getElementById('admin-map');
                const rect = mapContainer.getBoundingClientRect();
                hoverCard.style.left = (rect.left + point.x) + 'px';
                hoverCard.style.top = (rect.top + point.y + window.scrollY) + 'px';
                hoverCard.classList.remove('hidden');
                hoverCard.style.pointerEvents = 'auto';
            });
            
            marker.on('mouseout', function() {
                setTimeout(function() {
                    if (!hoverCard.matches(':hover')) {
                        hoverCard.classList.add('hidden');
                    }
                }, 100);
            });
            
            marker.bindPopup(
                '<div class="text-center">' +
                (d.photo_url ? '<img src="' + d.photo_url + '" class="w-16 h-16 mx-auto rounded-lg object-cover mb-2 border-2 border-red-100">' : '') +
                '<strong class="text-base">' + d.first_name + ' ' + d.last_name + '</strong><br>' +
                '<span class="text-gray-500 text-sm">' + d.city + ', ' + d.country + '</span><br>' +
                '<a href="/disparu/' + d.public_id + '" class="text-red-600 hover:underline text-sm mt-1 inline-block">{% if get_locale() == "fr" %}Voir la fiche{% else %}View profile{% endif %}</a>' +
                '</div>'
            );
            mapMarkers.push(marker);
        }
        });
        
        if (mapMarkers.length > 0) {
            const bounds = mapMarkers.map(m => m.getLatLng());
            map.fitBounds(bounds.map(b => [b.lat, b.lng]), {padding: [30, 30], maxZoom: 10});
        }
    }
    
    adminCountryFilter.addEventListener('change', function() {
        localStorage.setItem('disparus_admin_country_filter', this.value);
        updateAdminMap();
    });
    
    hoverCard.addEventListener('mouseleave', function() {
        hoverCard.classList.add('hidden');
    });
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                if (!adminCountryFilter.value) {
                    map.setView([position.coords.latitude, position.coords.longitude], 8);
                }
            },
            function() {},
            { enableHighAccuracy: false, timeout: 5000 }
        );
    }
    
    updateAdminMap();
</script>
{% endblock %}
