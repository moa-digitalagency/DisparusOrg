<!--
 * Nom de l'application : DISPARUS.ORG
 * Description : Carte interactive de l'administration
 * Produit de : MOA Digital Agency, www.myoneart.com
 * Fait par : Aisance KALONJI, www.aisancekalonji.com
 * Auditer par : La CyberConfiance, www.cyberconfiance.com
 -->
{% extends "admin_base.html" %}

{% block title %}Carte - Admin DISPARUS.ORG{% endblock %}

{% block page_title %}{% if get_locale() == 'fr' %}Carte interactive{% else %}Interactive map{% endif %}{% endblock %}
{% block page_subtitle %}{% if get_locale() == 'fr' %}Visualisation geographique des signalements{% else %}Geographic visualization of reports{% endif %}{% endblock %}

{% block admin_content %}
<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
    <div class="p-4 border-b border-gray-100 flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="text-sm text-gray-600">{% if get_locale() == 'fr' %}Disparu{% else %}Missing{% endif %}</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="text-sm text-gray-600">{% if get_locale() == 'fr' %}Retrouve{% else %}Found{% endif %}</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                <span class="text-sm text-gray-600">{% if get_locale() == 'fr' %}Signale{% else %}Flagged{% endif %}</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <select id="admin-country-filter" class="text-sm border border-gray-200 rounded-xl px-3 py-2 bg-white focus:ring-2 focus:ring-red-500 focus:border-red-500">
                <option value="">{% if get_locale() == 'fr' %}Tous les pays{% else %}All countries{% endif %}</option>
                {% set countries = disparus|map(attribute='country')|unique|sort %}
                {% for country in countries %}
                <option value="{{ country }}">{{ country }}</option>
                {% endfor %}
            </select>
            <span id="admin-count" class="text-sm text-gray-500">
                {{ disparus|length }} {% if get_locale() == 'fr' %}signalements{% else %}reports{% endif %}
            </span>
        </div>
    </div>
    <div id="admin-map" class="h-[600px]"></div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .hover-card {
        position: absolute;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        padding: 12px;
        z-index: 1000;
        pointer-events: none;
        min-width: 220px;
        max-width: 280px;
        border: 1px solid #e5e7eb;
        transform: translate(-50%, -100%);
        margin-top: -15px;
    }
    .hover-card img {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid #fee2e2;
    }
    .hover-card .no-photo {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
<div id="hover-card" class="hover-card hidden">
    <div class="flex gap-3">
        <div id="hover-photo"></div>
        <div class="flex-1">
            <div id="hover-name" class="font-semibold text-gray-900 text-sm"></div>
            <div id="hover-location" class="text-xs text-gray-500 mt-0.5"></div>
            <div id="hover-status" class="mt-1"></div>
            <div id="hover-date" class="text-xs text-gray-400 mt-1"></div>
        </div>
    </div>
    <a id="hover-link" href="#" class="block mt-2 text-center text-xs text-red-600 hover:text-red-700 font-medium py-1.5 bg-red-50 rounded-lg">
        {% if get_locale() == 'fr' %}Voir la fiche{% else %}View profile{% endif %}
    </a>
</div>
<script>
    const map = L.map('admin-map').setView([7.5, 15], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'OpenStreetMap'
    }).addTo(map);
    
    const hoverCard = document.getElementById('hover-card');
    const allDisparus = {{ disparus_list|tojson|safe if disparus_list else '[]' }};
    const adminCountryFilter = document.getElementById('admin-country-filter');
    const adminCount = document.getElementById('admin-count');
    let mapMarkers = [];
    
    const savedAdminCountry = localStorage.getItem('disparus_admin_country_filter');
    if (savedAdminCountry) {
        adminCountryFilter.value = savedAdminCountry;
    }
    
    function updateAdminMap() {
        mapMarkers.forEach(m => map.removeLayer(m));
        mapMarkers = [];
        
        const selectedCountry = adminCountryFilter.value;
        let filtered = allDisparus;
        
        if (selectedCountry) {
            filtered = allDisparus.filter(d => d.country === selectedCountry);
        }
        
        adminCount.textContent = filtered.length + ' {% if get_locale() == "fr" %}signalements{% else %}reports{% endif %}';
        
        filtered.forEach(function(d) {
            if (d.latitude && d.longitude) {
                const color = d.status === 'found' ? '#22c55e' : (d.is_flagged ? '#f97316' : '#ef4444');
                const marker = L.circleMarker([d.latitude, d.longitude], {
                    radius: 10,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);
            
            // Tooltip on hover (Photo + Name)
            const tooltipContent = '<div class="text-center p-1">' +
                (d.photo_url ? '<img src="' + d.photo_url + '" class="w-16 h-16 mx-auto rounded-lg object-cover mb-1">' : '') +
                '<div class="font-bold text-sm text-gray-900">' + escapeHtml(d.first_name) + ' ' + escapeHtml(d.last_name) + '</div>' +
                '<div class="text-xs text-gray-500">' + escapeHtml(d.city) + '</div>' +
                '</div>';
            
            marker.bindTooltip(tooltipContent, {
                direction: 'top',
                offset: [0, -5],
                opacity: 1,
                className: 'leaflet-tooltip-custom'
            });

            marker.on('click', function() {
                window.location.href = '/disparu/' + d.public_id;
            });
            mapMarkers.push(marker);
        }
        });
        
        if (mapMarkers.length > 0) {
            const bounds = mapMarkers.map(m => m.getLatLng());
            map.fitBounds(bounds.map(b => [b.lat, b.lng]), {padding: [30, 30], maxZoom: 10});
        }
    }
    
    adminCountryFilter.addEventListener('change', function() {
        localStorage.setItem('disparus_admin_country_filter', this.value);
        updateAdminMap();
    });
    
    hoverCard.addEventListener('mouseleave', function() {
        hoverCard.classList.add('hidden');
    });
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                if (!adminCountryFilter.value) {
                    map.setView([position.coords.latitude, position.coords.longitude], 8);
                }
            },
            function() {},
            { enableHighAccuracy: false, timeout: 5000 }
        );
    }
    
    updateAdminMap();
</script>
{% endblock %}
